<%- include('./partials/header'); %>
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.17/index.global.min.js"></script>
    <style>
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100vw;
        height: 100vh;
        background-color: rgba(0, 0, 0, 0.6);
        justify-content: center;
        align-items: center;
      }

      .modal-content {
        background-color: #ffffff;
        padding: 30px;
        border-radius: 16px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        max-width: 500px;
        width: 90%;
        animation: fadeIn 0.3s ease-in-out;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      }

      .modal-content h2 {
        margin-top: 0;
        font-size: 24px;
        color: #333;
      }

      .modal-content p {
        margin: 10px 0;
        color: #555;
        font-size: 16px;
      }

      .modal-content button {
        margin-top: 20px;
        padding: 10px 20px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 15px;
      }

      .modal-content button:hover {
        background-color: #0056b3;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: scale(0.9);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }
    </style>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        var calendarEl = document.getElementById("calendar");

        // Datos inyectados desde el servidor
        const eventos = JSON.parse('<%- eventos %>');
        console.log("Eventos recibidos desde el servidor:", eventos);
        const rolUsuario = "<%= rol %>";
        console.log("Rol del usuario:", rolUsuario);

        // Filtrar eventos según el rol
        const eventosFiltrados = eventos.filter(evento => {
          if (rolUsuario === 'Estudiante') {
            return true;
          }
          if (rolUsuario === 'Docente') {
            return true;
          }
          if (rolUsuario === 'Apoderado') {
            return true;
          }
          if (rolUsuario === 'Administrador') {
            return true; // El admin ve todo
          }
          return false;
        });

        console.log("Eventos filtrados según el rol:", eventosFiltrados);

        const calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: "dayGridMonth",
          events: eventosFiltrados,

          eventClick: function (info) {
            const evento = info.event;
            const modal = document.getElementById("myModal");
            const modalContent = document.getElementById("modalContent");

            modalContent.innerHTML = `
              <h2>${evento.title}</h2>
              <p><strong>Fecha:</strong> ${evento.start.toLocaleString()}</p>
              <p><strong>Tipo:</strong> ${evento.extendedProps.tipo}</p>
              <p><strong>Curso:</strong> ${evento.extendedProps.curso}</p>
              <p><strong>Colegio:</strong> ${evento.extendedProps.colegio}</p>
              <button id="closeModal">Cerrar</button>
            `;

            modal.style.display = "flex";

            document.getElementById("closeModal").onclick = function () {
              modal.style.display = "none";
            };
          }
        });

        calendar.render();

        window.onclick = function (event) {
          const modal = document.getElementById("myModal");
          if (event.target === modal) {
            modal.style.display = "none";
          }
        };
      });
    </script>
  </head>
  <body>
    <div id="calendar"></div>

    <!-- Modal -->
    <div id="myModal" class="modal">
      <div class="modal-content" id="modalContent"></div>
    </div>
  </body>
</html>
