<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Login</title>
  <link rel="stylesheet" href="/styles/style_login.css" />
</head>
<body>
  <div class="floating-message" id="floatingMessage"></div>
  <div class="container">
    <h2>Login</h2>
    <% if (typeof errorMessage !== 'undefined') { %>
      <p class="error-message"><%= errorMessage %></p>
    <% } %>

    <!-- LOGIN FORM -->
    <form action="/auth_login" method="POST">
      <input type="text" name="email" placeholder="Email" required />
      <input type="password" name="password" placeholder="Contraseña" required />
      <input type="submit" value="Login" />
    </form>

    <!-- REGISTRARSE BOTON -->
    <button type="button" class="register-btn" onclick="toggleForm('registerForm')">Registrarse</button>

    <!-- FORMULARIO DE REGISTRO -->
    <div class="register-form" id="registerForm" style="display: none;">
      <h2>Registro</h2>
      <form action="/create_user" method="POST">
        <input type="text" name="nombre" placeholder="Nombre" required />
        <input type="text" name="apellido" placeholder="Apellido" required />
        <input type="date" name="fecha_nacimiento" required />
        <input type="text" name="telefono" placeholder="Número Telefónico" required />
        <input type="email" name="email" placeholder="Email" required />
        <input type="password" name="password" placeholder="Contraseña" required />

        <!-- Tipo de perfil -->
        <select name="tipoPerfil" id="tipoPerfil" required onchange="mostrarCamposPerfil(this.value)">
          <option value="">Selecciona tu perfil</option>
          <option value="estudiante">Estudiante</option>
          <option value="docente">Docente</option>
          <option value="apoderado">Apoderado</option>
        </select>

        <!-- Selector de colegio (único) -->
        <select name="colegioId" id="colegioId" style="display: none;">
          <option value="">Selecciona Colegio</option>
          <% colegios.forEach(colegio => { %>
            <option value="<%= colegio.id %>"><%= colegio.nombre %></option>
          <% }); %>
        </select>

        <!-- Campos adicionales para ESTUDIANTE -->
        <div id="camposEstudiante" style="display:none;">
          <select name="cursoId">
            <option value="">Selecciona Curso</option>
            <% cursos.forEach(curso => { %>
              <option value="<%= curso.id %>"><%= curso.nombre %> - <%= curso.nivel %> (<%= curso.colegio.nombre %>)</option>
            <% }); %>
          </select>
          <input type="number" name="apoderadoId" placeholder="ID del Apoderado (opcional)">
        </div>

        <!-- Campos adicionales para DOCENTE -->
        <div id="camposDocente" style="display:none;">
          <!-- Puedes agregar más campos si lo deseas -->
        </div>

        <!-- Campos adicionales para APODERADO -->
        <div id="camposApoderado" style="display:none;">
          <!-- Por ahora vacío -->
        </div>

        <!-- Rol oculto -->
        <input type="hidden" name="rolId" id="rolId" />

        <input type="submit" value="Registrar" />
      </form>
    </div>

    <!-- Recuperar contraseña -->
    <p><a href="#" onclick="toggleForm('forgotPasswordForm')">¿Olvidaste tu contraseña?</a></p>
    <div class="forgot-password-form" id="forgotPasswordForm" style="display:none;">
      <h2>Recuperar Contraseña</h2>
      <form action="/recuperar_contrasena" method="POST">
        <input type="email" name="email" placeholder="Ingresa tu Email" required />
        <input type="submit" value="Recuperar Contraseña" />
      </form>
    </div>

    <!-- Validar cuenta -->
    <p><a href="#" onclick="toggleForm('validationForm')">¿Problemas con validar tu cuenta?</a></p>
    <div class="validation-form" id="validationForm" style="display:none;">
      <h2>Reenviar Correo de Validación</h2>
      <form action="/enviar_correo_cambio_rol" method="POST">
        <input type="email" name="email" placeholder="Ingresa tu Email" required />
        <input type="submit" value="Enviar Correo de Validación" />
      </form>
    </div>
  </div>

  <script>
    function toggleForm(formId) {
      const form = document.getElementById(formId);
      form.style.display = form.style.display === "none" || form.style.display === "" ? "block" : "none";
    }

    function showFloatingMessage(message, isError = false) {
      const floatingMessage = document.getElementById("floatingMessage");
      floatingMessage.textContent = message;
      floatingMessage.classList.toggle("error", isError);
      floatingMessage.classList.toggle("success", !isError);
      floatingMessage.style.display = "block";

      setTimeout(() => {
        floatingMessage.style.display = "none";
      }, 3000);
    }

    var successMessage = "<%= typeof successMessage !== 'undefined' ? successMessage : '' %>";
    var errorMessage = "<%= typeof errorMessage !== 'undefined' ? errorMessage : '' %>";

    if (successMessage) showFloatingMessage(successMessage);
    if (errorMessage) showFloatingMessage(errorMessage, true);

    function mostrarCamposPerfil(tipo) {
    document.getElementById("camposEstudiante").style.display = tipo === "estudiante" ? "block" : "none";
    document.getElementById("camposDocente").style.display = tipo === "docente" ? "block" : "none";
    document.getElementById("camposApoderado").style.display = tipo === "apoderado" ? "block" : "none";

    // Mostrar/ocultar colegio
    const colegioSelect = document.getElementById("colegioId");
    if (tipo === "estudiante" || tipo === "docente") {
      colegioSelect.style.display = "block";
      colegioSelect.setAttribute("required", true);
    } else {
      colegioSelect.style.display = "none";
      colegioSelect.removeAttribute("required");
      colegioSelect.value = "";
    }

    // Asignar rol
    const rolIdMap = {
      estudiante: 2,
      docente: 3,
      apoderado: 4
    };

    document.getElementById("rolId").value = rolIdMap[tipo] || '';
  }
  </script>
</body>
</html>
